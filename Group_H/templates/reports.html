{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>Executive Dashboard</h2>
        <p class="text-muted">Business Intelligence & Visual Analytics</p>
    </div>
    <div class="btn-group">
        <button id="btn-all" class="btn btn-outline-secondary active" onclick="toggleView('all')">View All</button>
        <button id="btn-charts" class="btn btn-outline-secondary" onclick="toggleView('charts')">Charts Only</button>
        <button id="btn-data" class="btn btn-outline-secondary" onclick="toggleView('data')">Data Only</button>
    </div>
</div>

<div id="charts-container">
    
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white d-flex justify-content-between">
                <h5 class="mb-0">Monthly Revenue Trend</h5>
                {% if trend_direction == 'up' %}
                    <small class="text-success fw-bold">↑ Growth</small>
                {% elif trend_direction == 'down' %}
                    <small class="text-danger fw-bold">↓ Decline</small>
                {% else %}
                    <small class="text-muted fw-bold">→ Stable</small>
                {% endif %}
            </div>
                <div class="card-body">
                    <canvas id="revenueChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Occupancy (Last 7 Days)</h5>
                </div>
                <div class="card-body">
                    <canvas id="occupancyChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white"><h5 class="mb-0">Revenue Mix (Non-Room)</h5></div>
                <div class="card-body">
                    <div style="max-width: 350px; margin: 0 auto;">
                        <canvas id="serviceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white"><h5 class="mb-0">Guest Composition</h5></div>
                <div class="card-body">
                    <div style="max-width: 350px; margin: 0 auto;">
                        <canvas id="demoChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div> <div id="data-container">
    <h4 class="mb-3 text-muted border-bottom pb-2">Detailed Reports</h4>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-white"><h5 class="mb-0">Top 10 High-Value Clients</h5></div>
                <div class="card-body">
                    <table class="table table-striped table-sm">
                        <thead><tr><th>Rank</th><th>Party Name</th><th>Stays</th><th class="text-end">Total Spend</th></tr></thead>
                        <tbody>
                            {% for row in report_revenue %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ row.partyName }}</td>
                                <td>{{ row.stays }}</td>
                                <td class="text-end fw-bold">${{ row.totalSpent }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-white"><h5 class="mb-0">Room Utilization</h5></div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead><tr><th>Type</th><th>Total</th><th>Occupied</th><th>Rate</th></tr></thead>
                        <tbody>
                            {% for row in report_util %}
                            <tr>
                                <td>{{ row.room_type }}</td>
                                <td>{{ row.total_rooms }}</td>
                                <td>{{ row.occupied_count }}</td>
                                <td>
                                    {% set rate = (row.occupied_count / row.total_rooms * 100)|round(1) if row.total_rooms > 0 else 0 %}
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar {% if rate > 70 %}bg-success{% elif rate > 30 %}bg-warning{% else %}bg-danger{% endif %}" 
                                             role="progressbar" style="width: {{ rate }}%">{{ rate }}%</div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-white"><h5 class="mb-0">Average Length of Stay</h5></div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead><tr><th>Room Type</th><th>Avg Nights</th></tr></thead>
                        <tbody>
                            {% for row in report_average_stay %}
                            <tr>
                                <td>{{ row.room_type }}</td>
                                <td><strong>{{ row.avg_stay }}</strong> Nights</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-white"><h5 class="mb-0">Weekly Peak Analysis</h5></div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead><tr><th>Weekday</th><th>Total Reservations</th></tr></thead>
                        <tbody>
                            {% for row in report_peak_occupancy %}
                            <tr>
                                <td>
                                    {% set days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'] %}
                                    {{ days[row.weekday|int] }}
                                </td>
                                <td><span class="badge bg-info text-dark">{{ row.reservations }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div> <script>
    // 1. Revenue
    new Chart(document.getElementById('revenueChart'), {
        type: 'line',
        data: {
            labels: {{ c1_labels | tojson }},
            datasets: [{
                label: 'Revenue ($)',
                data: {{ c1_data | tojson }},
                borderColor: '#c5a059', 
                backgroundColor: 'rgba(197, 160, 89, 0.1)',
                fill: true,
                tension: 0.3
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });

    // 2. Occupancy
    new Chart(document.getElementById('occupancyChart'), {
        type: 'bar',
        data: {
            labels: {{ c2_labels | tojson }},
            datasets: [{
                label: 'Occupied Rooms',
                data: {{ c2_data | tojson }},
                backgroundColor: '#1a2530', 
                borderRadius: 4
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    // 3. Service
    new Chart(document.getElementById('serviceChart'), {
        type: 'doughnut',
        data: {
            labels: {{ c3_labels | tojson }},
            datasets: [{
                data: {{ c3_data | tojson }},
                backgroundColor: ['#c5a059', '#1a2530', '#85929e', '#e74c3c'],
                hoverOffset: 4
            }]
        }
    });

    // 4. Demographics 
    new Chart(document.getElementById('demoChart'), {
        type: 'pie',
        data: {
            labels: {{ c4_labels | tojson }},
            datasets: [{
                data: {{ c4_data | tojson }},
                backgroundColor: ['#546e7a', '#b0bec5'],
                hoverOffset: 4
            }]
        }
    });

    function toggleView(mode) {
        const charts = document.getElementById('charts-container');
        const data = document.getElementById('data-container');
        
        const btnAll = document.getElementById('btn-all');
        const btnCharts = document.getElementById('btn-charts');
        const btnData = document.getElementById('btn-data');
        [btnAll, btnCharts, btnData].forEach(btn => btn.classList.remove('active'));

        if (mode === 'all') {
            charts.style.display = 'block';
            data.style.display = 'block';
            btnAll.classList.add('active');
        } 
        else if (mode === 'charts') {
            charts.style.display = 'block';
            data.style.display = 'none';
            btnCharts.classList.add('active');
        } 
        else if (mode === 'data') {
            charts.style.display = 'none';
            data.style.display = 'block';
            btnData.classList.add('active');
        }
    }
</script>
{% endblock %}
